<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        header { background-color: #333; color: white; padding: 10px 20px; text-align: center; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        aside { width: 250px; padding: 15px; background-color: #f4f4f4; overflow-y: auto; }
        main { flex: 1; padding: 15px; display: flex; flex-direction: column; overflow-y: auto; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background-color: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; }
        #map { height: 400px; width: 100%; }
        .filters label { display: block; margin-bottom: 5px; }
        .filters select { width: 100%; padding: 8px; margin-bottom: 10px; }
    </style>
</head>
<body>

<header>
    <h1>Dashboard de Análisis de Datos</h1>
</header>

<div class="main-container">
    <aside class="filters">
        <h2>Filtros</h2>
        <label for="poligonoFilter">Filtrar por Polígono:</label>
        <select id="poligonoFilter">
            <option value="all">Todos</option>
        </select>
        <label for="localidadFilter">Filtrar por Localidad:</label>
        <select id="localidadFilter">
            <option value="all">Todas</option>
        </select>
    </aside>

    <main>
        <div class="dashboard-grid">
            <div class="card">
                <h3>Total de Registros</h3>
                <p id="totalRegistros">0</p>
            </div>
            <div class="card">
                <h3>Total Hombres</h3>
                <p id="totalHombres">0</p>
            </div>
            <div class="card">
                <h3>Total Mujeres</h3>
                <p id="totalMujeres">0</p>
            </div>
             <div class="card">
                <h3>Tipo de Sangre Mas Comun</h3>
                <p id="tipoSangre">0</p>
            </div>
        </div>
        <div class="card" style="margin-top: 15px;">
            <h3>Gráfico por Género</h3>
            <canvas id="genderChart"></canvas>
        </div>
        <div class="card" style="margin-top: 15px;">
            <h3>Mapa de Localidades</h3>
            <div id="map"></div>
        </div>
    </main>
</div>

<script>
// 1. Global Variables
let dbData = [];
let genderChart;
let map = L.map('map').setView([18.92, -99.23], 9); // Centered on Morelos
let markers = L.layerGroup().addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// 2. DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    document.getElementById('poligonoFilter').addEventListener('change', updateLocalidadFilter);
    document.getElementById('localidadFilter').addEventListener('change', updateDashboard);
});

// 3. Load and Parse CSV Data
function loadData() {
    // ########### CORRECCIÓN AQUÍ ###########
    // Se cambió 'coincidencias_con_coordenadas.csv' por 'bdtpbv.csv'
    Papa.parse('bdtpbv.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            // Filter out rows that are null or have critical missing fields
            dbData = results.data.filter(row => row && row.Poligono && row.Localidad);
            if (dbData.length === 0) {
                console.error("No valid data loaded. Check CSV headers and content.");
                alert("No se cargaron datos válidos. Revisa las cabeceras y el contenido del archivo CSV.");
                return;
            }
            populatePoligonoFilter();
            updateLocalidadFilter(); // Initial population
            updateDashboard();
        },
        error: function(err, file) {
            console.error("Error parsing CSV:", err);
            alert("Error al cargar el archivo CSV. Revisa que el nombre del archivo sea correcto y que esté en la misma carpeta.");
        }
    });
}

// 4. Filter Population
function populatePoligonoFilter() {
    const poligonoFilter = document.getElementById('poligonoFilter');
    // Using Set to get unique values
    const poligonos = [...new Set(dbData.map(item => item.Poligono))];
    poligonos.sort().forEach(p => {
        const option = document.createElement('option');
        option.value = p;
        option.textContent = p;
        poligonoFilter.appendChild(option);
    });
}

function updateLocalidadFilter() {
    const poligonoFilterValue = document.getElementById('poligonoFilter').value;
    const localidadFilter = document.getElementById('localidadFilter');
    
    // Clear current options
    localidadFilter.innerHTML = '<option value="all">Todas</option>';

    let filteredData = dbData;
    if (poligonoFilterValue !== 'all') {
        filteredData = dbData.filter(item => item.Poligono === poligonoFilterValue);
    }
    
    const localidades = [...new Set(filteredData.map(item => item.Localidad))];
    localidades.sort().forEach(l => {
        const option = document.createElement('option');
        option.value = l;
        option.textContent = l;
        localidadFilter.appendChild(option);
    });

    updateDashboard(); // Update dashboard when polygon filter changes
}


// 5. Update Dashboard
function updateDashboard() {
    const poligonoFilterValue = document.getElementById('poligonoFilter').value;
    const localidadFilterValue = document.getElementById('localidadFilter').value;

    let filteredData = dbData;

    if (poligonoFilterValue !== 'all') {
        filteredData = filteredData.filter(item => item.Poligono === poligonoFilterValue);
    }
    if (localidadFilterValue !== 'all') {
        filteredData = filteredData.filter(item => item.Localidad === localidadFilterValue);
    }
    
    // Update KPIs
    const totalRegistros = filteredData.length;
    const totalHombres = filteredData.filter(item => item.Genero && item.Genero.toLowerCase() === 'hombre').length;
    const totalMujeres = filteredData.filter(item => item.Genero && item.Genero.toLowerCase() === 'mujer').length;

    document.getElementById('totalRegistros').textContent = totalRegistros;
    document.getElementById('totalHombres').textContent = totalHombres;
    document.getElementById('totalMujeres').textContent = totalMujeres;

    // Update Chart
    updateChart(totalHombres, totalMujeres);
    
    // Update Map
    updateMap(filteredData);
}

// 6. Update Chart
function updateChart(hombres, mujeres) {
    const ctx = document.getElementById('genderChart').getContext('2d');
    if (genderChart) {
        genderChart.destroy();
    }
    genderChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Hombres', 'Mujeres'],
            datasets: [{
                label: 'Distribución por Género',
                data: [hombres, mujeres],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// 7. Update Map
function updateMap(data) {
    markers.clearLayers();
    if (data.length === 0) return;

    data.forEach(item => {
        // Ensure lat and lon exist and are numbers
        if (typeof item.lat === 'number' && typeof item.lon === 'number') {
            const marker = L.marker([item.lat, item.lon]);
            // Create popup content
            let popupContent = `<b>Localidad:</b> ${item.Localidad}<br><b>Polígono:</b> ${item.Poligono}`;
            if(item.Nombre) popupContent += `<br><b>Nombre:</b> ${item.Nombre}`;
            marker.bindPopup(popupContent);
            markers.addLayer(marker);
        }
    });

    // Adjust map view to fit markers
    if (markers.getLayers().length > 0) {
        map.fitBounds(markers.getBounds().pad(0.1));
    }
}
</script>

</body>
</html>