<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD DE TPBV Análisis Sociodemográfico</title>
    
    <!-- Leaflet CSS for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PapaParse for easy CSV parsing in the browser -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* General styling for the body */
        body { 
            font-family: 'Roboto', sans-serif; 
            margin: 0; 
            background-color: #f0f2f5; 
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header styling */
        .header {
            background-color: #ffffff;
            padding: 15px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            border-bottom: 3px solid #007bff;
        }

        .header h1 {
            margin: 0;
            color: #0056b3;
            font-size: 1.8em;
        }

        /* Main dashboard container layout */
        .dashboard-container { 
            display: grid; 
            grid-template-columns: 380px 1fr; 
            flex-grow: 1;
            overflow: hidden;
        }

        /* Sidebar for filters and detailed info */
        .sidebar { 
            background-color: #ffffff; 
            padding: 25px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); 
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
        }

        /* Main content area for map and charts */
        .main-content { 
            padding: 25px; 
            overflow-y: auto; 
            background-color: #f9fafb;
        }

        /* Styling for filter groups */
        .filter-group { 
            margin-bottom: 25px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        label { 
            font-weight: 700; 
            margin-bottom: 10px; 
            display: block; 
            color: #495057;
        }

        select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 5px; 
            border: 1px solid #ced4da;
            background-color: #fff;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        select:focus {
            outline: none;
            border-color: #007bff;
        }

        /* Map container styling */
        #map { 
            height: 50vh; 
            width: 100%; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        /* Info cards for sociodemographic data */
        #info-display h2 {
            color: #0056b3;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .info-cards { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 15px; 
            margin-top: 20px; 
        }

        .card { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid #e0e0e0;
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .card h3 { 
            margin-top: 0; 
            color: #007bff; 
            font-size: 1.1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        
        .card p {
            margin: 8px 0;
            line-height: 1.6;
        }

        /* Charts section layout */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .chart-container { 
            background: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            height: 40vh;
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>DASHBOARD DE TPBV Análisis Sociodemográfico</h1>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="filter-group">
                <label for="poligono-filter">Filtrar por Polígono:</label>
                <select id="poligono-filter" onchange="updateLocalidadFilter()"></select>
            </div>
            <div class="filter-group">
                <label for="localidad-filter">Filtrar por Localidad:</label>
                <select id="localidad-filter" onchange="updateDashboard()"></select>
            </div>
            
            <div id="info-display">
                <h2 id="locality-name">Seleccione una localidad</h2>
                <div id="socio-data" class="info-cards">
                    <!-- Sociodemographic data cards will be populated here -->
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <div id="map"></div>
            <div class="charts-section">
                <div class="chart-container">
                    <canvas id="populationChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="educationChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="healthChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="housingChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <!-- Leaflet JS for map functionality -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // Global variables
        let dbData = [];
        let map;
        let marker;
        let charts = {};

        // 1. Initialize the dashboard once the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadData();
        });

        // 2. Initialize the Leaflet map
        function initMap() {
            // Centered on Morelos, Mexico
            map = L.map('map').setView([18.683, -99.166], 10); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // 3. Load and parse the CSV data file
        function loadData() {
            Papa.parse('coincidencias_con_coordenadas.csv', {
                download: true,
                header: true,
                dynamicTyping: true, // Automatically converts numbers and booleans
                skipEmptyLines: true,
                complete: function(results) {
                    dbData = results.data;
                    populatePoligonoFilter();
                    updateLocalidadFilter(); // Initial population of localities
                }
            });
        }
        
        // 4. Populate the polygon filter dropdown
        function populatePoligonoFilter() {
            const poligonoFilter = document.getElementById('poligono-filter');
            // Get unique, non-null, sorted polygon numbers
            const poligonos = [...new Set(dbData.map(item => item.Poligono))]
                                .filter(p => p != null && p !== '')
                                .sort((a,b) => a - b);
            
            // Add an "All" option to see all localities
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Todos los Polígonos';
            poligonoFilter.appendChild(allOption);
            
            poligonos.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = `Polígono ${p}`;
                poligonoFilter.appendChild(option);
            });
        }
        
        // 5. Update the locality filter based on the selected polygon
        function updateLocalidadFilter() {
            const poligonoFilterValue = document.getElementById('poligono-filter').value;
            const localidadFilter = document.getElementById('localidad-filter');
            localidadFilter.innerHTML = ''; // Clear previous options

            let filteredData = dbData;
            if (poligonoFilterValue !== 'all') {
                filteredData = dbData.filter(item => item.Poligono == poligonoFilterValue);
            }

            const localidades = [...new Set(filteredData.map(item => item.NOMGEO))]
                                  .filter(loc => loc != null && loc.trim() !== '')
                                  .sort();
            
            localidades.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                localidadFilter.appendChild(option);
            });
            // Automatically update the dashboard with the first locality
            if (localidades.length > 0) {
                updateDashboard();
            }
        }

        // 6. Main function to update all dashboard components
        function updateDashboard() {
            const selectedLocalidad = document.getElementById('localidad-filter').value;
            const data = dbData.find(item => item.NOMGEO === selectedLocalidad);

            if (data) {
                updateMap(data.Latitud, data.Longitud, data.NOMGEO);
                displayInfo(data);
                updateCharts(data);
            }
        }

        // 7. Update the map's view and marker
        function updateMap(lat, lon, name) {
            if (lat && lon) {
                const newLatLng = new L.LatLng(lat, lon);
                map.setView(newLatLng, 14);
                if (marker) {
                    marker.setLatLng(newLatLng).setPopupContent(`<b>${name}</b>`);
                } else {
                    marker = L.marker(newLatLng).addTo(map).bindPopup(`<b>${name}</b>`).openPopup();
                }
            }
        }

        // 8. Display sociodemographic information in cards
        function displayInfo(data) {
            document.getElementById('locality-name').textContent = data.NOMGEO;
            const container = document.getElementById('socio-data');
            container.innerHTML = ''; // Clear previous cards
            
            const infoMapping = {
                'Población': {
                    'Total': data.POB1,
                    'Mujeres': data.POB42,
                    'Hombres': data.POB84,
                },
                'Educación': {
                    'Analfabetismo (15+ años)': data.EDU28,
                    'Asistencia Escolar (3-5 años)': data.EDU1_R + '%',
                    'Grado Promedio Escolaridad': data.EDU49_R,
                },
                'Economía': {
                    'Pob. Económicamente Activa': data.ECO1,
                    'Pob. Ocupada sin Escolaridad': data.ECO7,
                },
                'Salud': {
                    'Con Afiliación': data.SALUD1,
                    'Sin Afiliación': data.SALUD2,
                },
                'Vivienda': {
                    'Con Piso de Tierra': data.VIV7,
                    'Con Energía Eléctrica': data.VIV15,
                    'Con Refrigerador': data.VIV27
                },
                'Discapacidad': {
                    '0-14 años': data.DISC4,
                    '15-59 años': data.DISC5
                },
                 'Marginalidad': {
                    'Grado': data.GM_2020_y,
                    'Índice': data.IMN_2020_y ? data.IMN_2020_y.toFixed(4) : 'N/A'
                }
            };
            
            for (const category in infoMapping) {
                const card = document.createElement('div');
                card.className = 'card';
                let content = `<h3>${category}</h3>`;
                for (const [key, value] of Object.entries(infoMapping[category])) {
                    content += `<p><strong>${key}:</strong> ${value !== undefined && value !== null ? value : 'N/A'}</p>`;
                }
                card.innerHTML = content;
                container.appendChild(card);
            }
        }

        // 9. Update all charts with new data
        function updateCharts(data) {
            // Destroy previous chart instances to prevent memory leaks
            Object.values(charts).forEach(chart => chart.destroy());

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } }
            };

            // Population Chart (Bar)
            const popCtx = document.getElementById('populationChart').getContext('2d');
            charts.population = new Chart(popCtx, {
                type: 'bar',
                data: {
                    labels: ['Mujeres', 'Hombres'],
                    datasets: [{
                        label: 'Población por Género',
                        data: [data.POB42, data.POB84],
                        backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)'],
                        borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)'],
                        borderWidth: 1
                    }]
                },
                options: { ...chartOptions, scales: { y: { beginAtZero: true } } }
            });

            // Education Chart (Doughnut)
            const eduCtx = document.getElementById('educationChart').getContext('2d');
            charts.education = new Chart(eduCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Analfabeta (15+)', 'Alfabetizada (15+)'],
                    datasets: [{
                        label: 'Tasa de Analfabetismo',
                        data: [data.EDU28, data.POB1 - data.EDU28],
                        backgroundColor: ['rgba(255, 159, 64, 0.6)', 'rgba(201, 203, 207, 0.6)'],
                        borderColor: ['rgba(255, 159, 64, 1)', 'rgba(201, 203, 207, 1)'],
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });
            
            // Health Chart (Pie)
            const healthCtx = document.getElementById('healthChart').getContext('2d');
            charts.health = new Chart(healthCtx, {
                type: 'pie',
                data: {
                    labels: ['Con Afiliación', 'Sin Afiliación'],
                    datasets: [{
                        label: 'Acceso a Servicios de Salud',
                        data: [data.SALUD1, data.SALUD2],
                        backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'],
                        borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            // Housing Chart (Horizontal Bar)
            const housingCtx = document.getElementById('housingChart').getContext('2d');
            charts.housing = new Chart(housingCtx, {
                type: 'bar',
                data: {
                    labels: ['Con Electricidad', 'Con Refrigerador', 'Con Piso de Tierra'],
                    datasets: [{
                        label: 'Viviendas por Característica',
                        data: [data.VIV15, data.VIV27, data.VIV7],
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: { ...chartOptions, indexAxis: 'y', scales: { x: { beginAtZero: true } } }
            });
        }
    </script>
</body>
</html>
