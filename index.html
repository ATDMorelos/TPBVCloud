<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard TPBV - Análisis Sociodemográfico</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colores Primarios del Gobierno de Morelos */
            --color-primary: #71785b; /* Verde principal */
            --color-secondary: #bc9b73; /* Beige secundario */
            --color-dark-green: #2E3B2B; /* Verde oscuro */
            --color-light-gray: #CBCABE; /* Gris claro */
            --color-purple: #773357; /* Púrpura */
            --color-brown: #7C4A36; /* Café */
            
            /* Tonalidades y variaciones */
            --color-primary-80: rgba(113, 120, 91, 0.8);
            --color-primary-60: rgba(113, 120, 91, 0.6);
            --color-primary-40: rgba(113, 120, 91, 0.4);
            --color-primary-20: rgba(113, 120, 91, 0.2);
            --color-primary-10: rgba(113, 120, 91, 0.1);
            
            --color-secondary-80: rgba(188, 155, 115, 0.8);
            --color-secondary-60: rgba(188, 155, 115, 0.6);
            --color-secondary-40: rgba(188, 155, 115, 0.4);
            --color-secondary-20: rgba(188, 155, 115, 0.2);
            
            /* Colores de estado */
            --color-success: #71785b;
            --color-warning: #bc9b73;
            --color-danger: #773357;
            --color-info: #7C4A36;
            
            /* Tipografía */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-weight-light: 300;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-dark-green) 100%);
            min-height: 100vh;
            color: var(--color-dark-green);
            font-weight: var(--font-weight-regular);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: var(--font-weight-bold);
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: var(--font-weight-medium);
            color: var(--color-light-gray);
        }

        .header .subtitle {
            font-size: 1rem;
            margin-top: 10px;
            opacity: 0.8;
            font-weight: var(--font-weight-regular);
            font-style: italic;
        }

        .controls {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(46, 59, 43, 0.15);
            border: 2px solid var(--color-primary-20);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: var(--font-weight-semibold);
            margin-bottom: 10px;
            color: var(--color-dark-green);
            font-size: 1rem;
            letter-spacing: 0.01em;
        }

        .form-group select, .form-group input {
            padding: 15px 18px;
            border: 2px solid var(--color-light-gray);
            border-radius: 12px;
            font-size: 1rem;
            font-family: var(--font-family);
            font-weight: var(--font-weight-regular);
            transition: all 0.3s ease;
            background: white;
            color: var(--color-dark-green);
        }

        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px var(--color-primary-20);
            transform: translateY(-1px);
        }

        .form-group select:hover, .form-group input:hover {
            border-color: var(--color-primary-80);
        }

        .btn {
            padding: 15px 28px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-dark-green));
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            font-family: var(--font-family);
            transition: all 0.3s ease;
            height: fit-content;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--color-primary-40);
            background: linear-gradient(135deg, var(--color-dark-green), var(--color-primary));
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(46, 59, 43, 0.15);
            border: 2px solid var(--color-primary-20);
        }

        .map-container h3 {
            color: var(--color-dark-green);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4rem;
            font-weight: var(--font-weight-bold);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #map {
            height: 420px;
            border-radius: 15px;
            border: 3px solid var(--color-primary-40);
            box-shadow: 0 5px 20px rgba(113, 120, 91, 0.3);
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(46, 59, 43, 0.15);
            border: 2px solid var(--color-primary-20);
            overflow-y: auto;
            max-height: 500px;
        }

        .info-panel h3 {
            color: var(--color-dark-green);
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.4rem;
            font-weight: var(--font-weight-bold);
            padding-bottom: 15px;
            border-bottom: 3px solid var(--color-primary-20);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .data-section {
            margin-bottom: 28px;
            padding: 20px;
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
            border-radius: 15px;
            border-left: 5px solid var(--color-primary);
            box-shadow: 0 4px 15px rgba(113, 120, 91, 0.1);
            transition: all 0.3s ease;
        }

        .data-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(113, 120, 91, 0.15);
        }

        .data-section h4 {
            color: var(--color-primary);
            margin-bottom: 15px;
            font-size: 1.15rem;
            font-weight: var(--font-weight-bold);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        .data-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--color-light-gray);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(113, 120, 91, 0.08);
        }

        .data-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(113, 120, 91, 0.2);
            border-color: var(--color-primary);
        }

        .data-item strong {
            color: var(--color-dark-green);
            font-size: 0.9rem;
            font-weight: var(--font-weight-semibold);
            display: block;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .data-item span {
            color: var(--color-primary);
            font-size: 1.2rem;
            font-weight: var(--font-weight-bold);
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(46, 59, 43, 0.15);
            border: 2px solid var(--color-primary-20);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(46, 59, 43, 0.2);
        }

        .chart-card h4 {
            color: var(--color-dark-green);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: var(--font-weight-bold);
        }

        .chart-container {
            position: relative;
            height: 320px;
        }

        .loading {
            text-align: center;
            color: var(--color-primary-80);
            font-style: italic;
            padding: 50px;
            font-weight: var(--font-weight-medium);
        }

        .alert {
            background: var(--color-secondary-20);
            border: 2px solid var(--color-secondary);
            color: var(--color-dark-green);
            padding: 20px;
            border-radius: 12px;
            margin: 25px 0;
            text-align: center;
            font-weight: var(--font-weight-medium);
            font-size: 1.05rem;
        }

        .alert.success {
            background: var(--color-primary-20);
            border-color: var(--color-primary);
            color: var(--color-dark-green);
        }

        .alert.info {
            background: rgba(124, 74, 54, 0.1);
            border-color: var(--color-info);
            color: var(--color-dark-green);
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }

            .header p {
                font-size: 1.1rem;
            }
        }

        .no-data {
            text-align: center;
            color: var(--color-primary-80);
            font-style: italic;
            padding: 50px;
            background: var(--color-primary-10);
            border-radius: 15px;
            border: 2px dashed var(--color-primary-40);
            font-weight: var(--font-weight-medium);
        }

        /* Estilos específicos para los pop-ups del mapa */
        .leaflet-popup-content-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(46, 59, 43, 0.2);
            border: 2px solid var(--color-primary-20);
        }

        .leaflet-popup-content {
            font-family: var(--font-family);
            color: var(--color-dark-green);
            font-weight: var(--font-weight-regular);
        }

        .leaflet-popup-tip {
            background: white;
            border: 2px solid var(--color-primary-20);
        }

        /* Personalización de marcadores */
        .custom-marker {
            background-color: var(--color-primary);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(113, 120, 91, 0.4);
        }

        /* Scrollbar personalizado */
        .info-panel::-webkit-scrollbar {
            width: 8px;
        }

        .info-panel::-webkit-scrollbar-track {
            background: var(--color-light-gray);
            border-radius: 4px;
        }

        .info-panel::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-radius: 4px;
        }

        .info-panel::-webkit-scrollbar-thumb:hover {
            background: var(--color-dark-green);
        }

        /* Animaciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .data-section {
            animation: fadeInUp 0.6s ease forwards;
        }

        .government-branding {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .government-branding::before {
            content: "🏛️";
            font-size: 1.2rem;
        }

        .government-branding .tagline {
            color: var(--color-light-gray);
            font-size: 0.95rem;
            font-weight: var(--font-weight-medium);
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DASHBOARD DE TPBV</h1>
            <p>Análisis Sociodemográfico - Estado de Morelos</p>
            <div class="government-branding">
                <span class="tagline">La tierra que nos une</span>
            </div>
            <div class="subtitle">Gobierno del Estado 2024-2030</div>
        </div>

        <div class="controls">
            <div class="form-group">
                <label for="poligono-select">🗺️ Filtrar por Polígono:</label>
                <select id="poligono-select">
                    <option value="">Seleccione un polígono</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="localidad-select">📍 Filtrar por Localidad:</label>
                <select id="localidad-select" disabled>
                    <option value="">Primero seleccione un polígono</option>
                </select>
            </div>

            <div class="form-group">
                <label for="municipio-filter">🔍 Buscar por Municipio:</label>
                <input type="text" id="municipio-filter" placeholder="Escriba el nombre del municipio">
            </div>
            
            <button class="btn" onclick="clearFilters()">🔄 Limpiar Filtros</button>
        </div>

        <div class="content-grid">
            <div class="map-container">
                <h3>🗺️ Ubicación Geográfica</h3>
                <div id="map"></div>
            </div>

            <div class="info-panel">
                <h3>📊 Información Sociodemográfica</h3>
                <div id="info-content">
                    <div class="alert info">
                        Seleccione un polígono y localidad para ver los datos sociodemográficos detallados del Estado de Morelos.
                    </div>
                </div>
            </div>
        </div>

        <div class="charts-container" id="charts-container" style="display: none;">
            <div class="chart-card">
                <h4>👥 Distribución de Población</h4>
                <div class="chart-container">
                    <canvas id="populationChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h4>🎓 Nivel Educativo</h4>
                <div class="chart-container">
                    <canvas id="educationChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h4>🏥 Servicios de Salud</h4>
                <div class="chart-container">
                    <canvas id="healthChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h4>🏠 Características de Vivienda</h4>
                <div class="chart-container">
                    <canvas id="housingChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let csvData = [];
        let map;
        let markersLayer;
        let charts = {};

        // Colores institucionales del Gobierno de Morelos
        const GOVERNMENT_COLORS = {
            primary: '#71785b',
            secondary: '#bc9b73',
            darkGreen: '#2E3B2B',
            lightGray: '#CBCABE',
            purple: '#773357',
            brown: '#7C4A36',
            primaryRGB: 'rgb(113, 120, 91)',
            secondaryRGB: 'rgb(188, 155, 115)',
            darkGreenRGB: 'rgb(46, 59, 43)',
            purpleRGB: 'rgb(119, 51, 87)',
            brownRGB: 'rgb(124, 74, 54)',
            lightGrayRGB: 'rgb(203, 202, 190)'
        };

        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            loadCSVData();
            initMap();
            setupEventListeners();
        });

        // Cargar datos del CSV
        async function loadCSVData() {
            try {
                const response = await window.fs.readFile('bdtpbv.csv', { encoding: 'utf8' });
                csvData = parseCSV(response);
                populateFilters();
                console.log('Datos cargados:', csvData.length, 'registros');
            } catch (error) {
                console.error('Error cargando datos:', error);
                document.getElementById('info-content').innerHTML = 
                    '<div class="alert" style="background: rgba(119, 51, 87, 0.1); border-color: #773357;">❌ Error al cargar los datos. Verifique que el archivo CSV esté disponible.</div>';
            }
        }

        // Parsear CSV
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length === headers.length) {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    // Solo incluir registros con coordenadas válidas
                    if (obj.Latitud && obj.Longitud && obj.Latitud !== '0' && obj.Longitud !== '0') {
                        data.push(obj);
                    }
                }
            }
            return data;
        }

        // Poblar filtros
        function populateFilters() {
            const poligonoSelect = document.getElementById('poligono-select');
            const poligonos = [...new Set(csvData.map(item => item.Poligono))].filter(p => p).sort((a, b) => parseInt(a) - parseInt(b));
            
            poligonos.forEach(poligono => {
                const option = document.createElement('option');
                option.value = poligono;
                option.textContent = `Polígono ${poligono}`;
                poligonoSelect.appendChild(option);
            });
        }

        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([18.8, -99.1], 9);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors | Gobierno del Estado de Morelos 2024-2030'
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);
        }

        // Configurar event listeners
        function setupEventListeners() {
            const poligonoSelect = document.getElementById('poligono-select');
            const localidadSelect = document.getElementById('localidad-select');
            const municipioFilter = document.getElementById('municipio-filter');

            poligonoSelect.addEventListener('change', function() {
                updateLocalidadFilter();
                if (this.value) {
                    filterByPoligono(this.value);
                } else {
                    clearMap();
                    clearInfo();
                }
            });

            localidadSelect.addEventListener('change', function() {
                if (this.value) {
                    showLocalidadData(this.value);
                }
            });

            municipioFilter.addEventListener('input', function() {
                filterByMunicipio(this.value);
            });
        }

        // Actualizar filtro de localidades
        function updateLocalidadFilter() {
            const poligonoSelect = document.getElementById('poligono-select');
            const localidadSelect = document.getElementById('localidad-select');
            
            localidadSelect.innerHTML = '<option value="">Seleccione una localidad</option>';
            
            if (poligonoSelect.value) {
                const localidades = csvData
                    .filter(item => item.Poligono === poligonoSelect.value && item.NOMGEO)
                    .map(item => ({ code: item.LOC, name: item.NOMGEO }))
                    .filter((item, index, self) => index === self.findIndex(t => t.code === item.code));
                
                localidades.forEach(localidad => {
                    const option = document.createElement('option');
                    option.value = localidad.code;
                    option.textContent = localidad.name;
                    localidadSelect.appendChild(option);
                });
                
                localidadSelect.disabled = false;
            } else {
                localidadSelect.disabled = true;
            }
        }

        // Filtrar por polígono
        function filterByPoligono(poligono) {
            const filteredData = csvData.filter(item => item.Poligono === poligono);
            updateMap(filteredData);
        }

        // Filtrar por municipio
        function filterByMunicipio(municipio) {
            if (municipio.length > 2) {
                const filteredData = csvData.filter(item => 
                    item.NOM_MUN && item.NOM_MUN.toLowerCase().includes(municipio.toLowerCase())
                );
                updateMap(filteredData);
                updateMunicipioInfo(filteredData, municipio);
            } else if (municipio.length === 0) {
                clearMap();
                clearInfo();
            }
        }

        // Mostrar datos de localidad
        function showLocalidadData(localidadCode) {
            const poligonoSelect = document.getElementById('poligono-select');
            const localidadData = csvData.find(item => 
                item.Poligono === poligonoSelect.value && item.LOC === localidadCode
            );
            
            if (localidadData) {
                updateMap([localidadData]);
                displayDetailedInfo(localidadData);
                createCharts(localidadData);
            }
        }

        // Actualizar mapa con marcadores personalizados
        function updateMap(data) {
            clearMap();
            
            if (data.length === 0) return;

            const bounds = [];
            
            data.forEach(item => {
                if (item.Latitud && item.Longitud) {
                    const lat = parseFloat(item.Latitud);
                    const lng = parseFloat(item.Longitud);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        // Crear ícono personalizado con colores institucionales
                        const customIcon = L.divIcon({
                            html: `<div style="
                                background-color: ${GOVERNMENT_COLORS.primary};
                                width: 20px;
                                height: 20px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 4px 15px rgba(113, 120, 91, 0.4);
                            "></div>`,
                            className: 'custom-marker',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });

                        const marker = L.marker([lat, lng], { icon: customIcon }).addTo(markersLayer);
                        marker.bindPopup(`
                            <div style="text-align: center; font-family: 'Inter', sans-serif;">
                                <h4 style="color: ${GOVERNMENT_COLORS.darkGreen}; margin-bottom: 12px; font-weight: 700; font-size: 1.1rem;">${item.NOMGEO || 'Sin nombre'}</h4>
                                <div style="text-align: left;">
                                    <p style="margin: 8px 0; color: ${GOVERNMENT_COLORS.primary}; font-weight: 600;"><strong>🏛️ Municipio:</strong> ${item.NOM_MUN}</p>
                                    <p style="margin: 8px 0; color: ${GOVERNMENT_COLORS.primary}; font-weight: 600;"><strong>🗺️ Polígono:</strong> ${item.Poligono}</p>
                                    <p style="margin: 8px 0; color: ${GOVERNMENT_COLORS.primary}; font-weight: 600;"><strong>👥 Población Total:</strong> ${item.POB1 || 'N/D'}</p>
                                    <p style="margin: 8px 0; color: ${GOVERNMENT_COLORS.secondary}; font-weight: 500; font-size: 0.9rem;"><em>Grado de Marginación: ${item.GM_2020_y || 'N/D'}</em></p>
                                </div>
                            </div>
                        `);
                        bounds.push([lat, lng]);
                    }
                }
            });

            if (bounds.length > 0) {
                if (bounds.length === 1) {
                    map.setView(bounds[0], 14);
                } else {
                    map.fitBounds(bounds, { padding: [25, 25] });
                }